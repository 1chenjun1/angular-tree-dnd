/**
 * The MIT License (MIT)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */
/**
 * Implementing TreeDnD & Event DrapnDrop (allow drag multi tree-table include all type: table, ol, ul)
 * Demo: http://thienhung1989.github.io/angular-tree-dnd
 * Github: https://github.com/thienhung1989/angular-tree-dnd
 * @version 3.0.1
 * (c) 2015 Nguyuễn Thiện Hùng - <nguyenthienhung1989@gmail.com>
 */
(function(){"use strict";angular.module("ntt.TreeDnD",["template/TreeDnD/TreeDnD.html"]).constant("$TreeDnDClass",{tree:"tree-dnd",empty:"tree-dnd-empty",hidden:"tree-dnd-hidden",node:"tree-dnd-node",nodes:"tree-dnd-nodes",handle:"tree-dnd-handle",place:"tree-dnd-placeholder",drag:"tree-dnd-drag",status:"tree-dnd-status",icon:{1:"glyphicon glyphicon-minus",0:"glyphicon glyphicon-plus","-1":"glyphicon glyphicon-file"}}).directive("compile",["$compile",function(e){return{restrict:"A",link:function(n,t,a){n.$watch(a.compile,function(a){if(a){var l=e(a),r=l(n);t.empty().append(r)}})}}}]).directive("treeDndNodeHandle",function(){return{restrict:"A",scope:!0,link:function(e,n,t){e.$element=n,e.$type="TreeDnDNodeHandle",e["class"].handle&&n.addClass(e["class"].handle)}}}).directive("treeDndNode",function(){return{restrict:"A",replace:!0,controller:["$scope",function(e){e.$modelValue=null,e.$scopeChildren=null,e.elementChilds=null,e.prev=function(){return e.getPrevGlobal(e.$modelValue.__index_real__)},e.getData=function(){return e.$modelValue},e.setElementChilds=function(n){e.elementChilds=n},e.getScopeNode=function(){return e}}],link:function(e,n,t){e.$element=n,e.$type="TreeDnDNode",e.$icon_class="",e.$node_class="",e["class"].node&&(n.addClass(e["class"].node),e.$node_class=e["class"].node),e.$watch(t.treeDndNode,function(e,n,t){t.setScope(t,e),t.$modelValue=e,t.$icon_class=t["class"].icon[e.__icon__]},!0)}}}).directive("treeDndNodes",function(){return{restrict:"A",replace:!0,link:function(e,n,t){e.$type="TreeDnDNodes",e.$element=n,e.nodes=[],e.$nodes_class="",e.setElementChilds&&e.setElementChilds(n),e.$watch(t.treeDndNodes,function(e,n,t){t.nodes=e},!0),e["class"].nodes&&(n.addClass(e["class"].nodes),e.$nodes_class=e["class"].nodes)}}}).directive("treeDnd",["$timeout","$http","$compile","$window","$document","$TreeDnDTemplate","$TreeDnDClass","$TreeDnDHelper","$templateCache",function(e,n,t,a,l,r,o,d,i){return{restrict:"E",replace:!0,scope:{treeData:"=",on_select:"&onSelect",on_click:"&onClick",tree:"=treeControl",expandOn:"=",columnDefs:"=",callbacks:"=",primaryKey:"="},controller:["$scope","$element","$attrs",function(e,n,t){e.dragEnabled=!0,e.dropEnabled=!0,e.dragDelay=0,e.indent=20,e.indent_plus=15,e.indent_unit="px",e.tree_class="table",e.primary_key="__uid__",e.enabledMove=!0,e.statusMove=!0,e.enabledHotkey=!1,e.tree_data=e.treeData,e.dragBorder=30,e.horizontal=null,e.$type="TreeDnD",e.colDefinitions=[],e.$globals={},e["class"]={},e.tree_nodes=[],e.elementChilds=null,e.statusElm=null,e.placeElm=null,e.dragging=null,e.for_all_descendants=function(n,t){if(angular.isFunction(t)){var a,l,r;if(t(n))return!1;for(r=n.__children__,l=r.length,a=0;l>a;a++)e.for_all_descendants(r[a],t)}return!0},e.$callbacks={accept:function(e,n,t){return!0},beforeDrag:function(e){return!0},dragStart:function(e){},dragMove:function(e){},dragStop:function(e,n){},beforeDrop:function(e){return!0},calsIndent:function(n,t,a){var l=0,r=a?0:e.indent_plus;return t||(l=e.indent_unit?e.indent_unit:"px"),1>n-1?r+l:e.indent*(n-1)+r+l},droppable:function(){return e.dropEnabled},draggable:function(){return e.dragEnabled},changeKey:function(n){var t;n.__uid__=Math.random(),n.__selected__&&delete n.__selected__,"__uid__"!==e.primary_key&&(t=""+n[e.primary_key],t=t.replace(/_#.+$/g,"")+"_#"+n.__uid__,n[e.primary_key]=t)},clone:function(n){var t=angular.copy(n);return e.for_all_descendants(t,this.changeKey),t},remove:function(e,n){return n.splice(e.__index__,1)[0]},add:function(e,n,t){return t?(t.length>-1&&n>-1?t.splice(n,0,e):t.push(e),!0):!1},dropped:function(e,n,t){if(!e)return null;if(!e.changed&&t)return!1;var a=e.node,l=null,r=e.move,o=null,d=e.parent||e.drag.treeData,i=r.parent||e.target.treeData;return t?(o=d,o.__children__&&(o=o.__children__),l=e.target.$callbacks.remove(a,o)):l=e.target.$callbacks.clone(a),t&&e.drag===e.target&&d===i&&r.pos>=e.node.__index__&&r.pos--,o=i,o.__children__&&(o=o.__children__),e.target.$callbacks.add(l,r.pos,o)}},e.setElementChilds=function(n){e.elementChilds=n},e.setDragging=function(n){e.dragging=n},e.toggleExpand=function(e){e.__children__.length>0&&(e.__expanded__=!e.__expanded__)},e.getScopeTree=function(){return e},e.getPrevGlobal=function(n){return n>0?e.tree_nodes[n-1]:null},e.getPrevSibling=function(n){if(n&&n.__index__>0){var t,a=n.__index__-1;return null!==n.__parent_real__?(t=e.tree_nodes[n.__parent_real__],t.__children__[a]):e.treeData[a]}return null},e.getNextGlobal=function(n){return n>0?e.tree_nodes[n-1]:null},e.getNode=function(n){return null===n?null:e.tree_nodes[n]},e.getHash=function(n){return"__uid__"===e.primary_key?"#"+n.__parent__+"#"+n.__uid__:"#"+n.__parent__+"#"+n[e.primary_key]},e.setScope=function(n,t){var a=e.getHash(t);e.$globals[a]!==n&&(e.$globals[a]=n)},e.getScope=function(n){return n?e.$globals[e.getHash(n)]:e},e.enableMove=function(n){e.enabledMove="boolean"==typeof n?n:!0},e.visible=function(n){return n?n.__visible__?n:e.visible(e.tree_nodes[n.__parent_real__]):null},t.enableStatus?(e.enabledStatus=!1,e.hideStatus=function(){e.statusElm&&e.statusElm.addClass(e["class"].hidden)},e.refreshStatus=function(){if(e.dragging&&e.enabledStatus){var n=e.statusElm;e.statusElm=angular.element(e.enabledMove?r.getMove(e):r.getCopy(e)),n!==e.statusElm&&(n&&(e.statusElm.attr("class",n.attr("class")),e.statusElm.attr("style",n.attr("style")),n.remove()),l.find("body").append(e.statusElm)),e.statusElm.removeClass(e["class"].hidden)}},e.setPositionStatus=function(n,t){e.statusElm&&(e.statusElm.css({left:n.pageX+10+"px",top:n.pageY+15+"px","z-index":9999}),e.statusElm.addClass(e["class"].status))}):e.enabledStatus=null,e.initPlace=function(n,t){var l=null,r=!1;if(n?(l=n.prop("tagName").toLowerCase(),r="tr"===l||"td"===l):(l=e.elementChilds.prop("tagName").toLowerCase(),r="tbody"===l||"table"===l),!e.placeElm)if(r){e.placeElm=angular.element(a.document.createElement("tr"));var o=e.colDefinitions.length;for(e.placeElm.append(angular.element(a.document.createElement("td")).addClass(e["class"].empty).addClass("indented").addClass(e["class"].place));o-->0;)e.placeElm.append(angular.element(a.document.createElement("td")).addClass(e["class"].empty).addClass(e["class"].place))}else e.placeElm=angular.element(a.document.createElement("li")).addClass(e["class"].empty).addClass(e["class"].place);return t&&e.placeElm.css("height",d.height(t)+"px"),n?n[0].parentNode.insertBefore(e.placeElm[0],n[0]):e.elementChilds.append(e.placeElm),e.placeElm},e.hidePlace=function(){e.placeElm&&e.placeElm.addClass(e["class"].hidden)},e.showPlace=function(){e.placeElm&&e.placeElm.removeClass(e["class"].hidden)}}],link:function(s,c,_){s.$watch(_.enableStatus,function(e){"boolean"==typeof e&&(s.enabledStatus=e)},!0),s.$watch(_.enableMove,function(e){"boolean"==typeof e&&(s.enabledMove=e)},!0),s.$watch(_.horizontal,function(e){"boolean"==typeof e&&(s.horizontal=e)},!0),_.enableStatus&&(s.$watch(_.templateCopy,function(e){var n=null;"string"==typeof e&&e.trim().length>0?n=e.trim():(n=_.templateCopy,n&&(n=n.trim(),0!==n.length||i.get(n)||(n=null))),n&&i.get(n)&&r.setCopy(n,s)},!0),s.$watch(_.templateMove,function(e){var n=null;"string"==typeof e&&e.trim().length>0?n=e.trim():(n=_.templateMove,n&&(n=n.trim(),0!==n.length||i.get(n)||(n=null))),n&&i.get(n)&&r.setMove(n,s)},!0)),_.primaryKey?s.$watch(_.primaryKey,function(e){s.primary_key="string"==typeof e?e:_.primaryKey},!0):"__uid__"===s.primary_key,s.$watch(_.callbacks,function(e){angular.forEach(e,function(e,n){"function"==typeof e&&s.$callbacks[n]&&(s.$callbacks[n]=e)})},!0),_.treeClass&&(/^(\s+[\w\-]+){2,}$/g.test(" "+_.treeClass)?s.tree_class=_.treeClass.trim():s.$watch(_.treeClass,function(e){switch(typeof e){case"string":s.tree_class=e;break;case"object":angular.extend(s["class"],e);break;default:s.tree_class=_.treeClass}},!0)),s.$watch(_.indentUnit,function(e){s.indent_unit="string"==typeof e?e:_.indentUnit},!0),s.$watch(_.enableHotkey,function(e){"boolean"==typeof e&&(s.enabledHotkey=e),s.enabledMove=s.enabledHotkey?!1:s.statusMove},!0),s.$watch(_.enableDrag,function(e){"boolean"==typeof e?s.dragEnabled=e:"boolean"==typeof _.enableDrag&&(s.dragEnabled=_.enableDrag)},!0),s.$watch(_.enableDrop,function(e){"boolean"==typeof e?s.dropEnabled=e:"boolean"==typeof _.enableDrop&&(s.dropEnabled=_.enableDrop)},!0),s.$watch(_.dragBorder,function(e){"number"==typeof e?s.dragBorder=e:"number"==typeof _.dragBorder&&(s.dragBorder=_.dragBorder)},!0),s.$watch(_.indent,function(e){"number"==typeof e?s.indent=e:"number"==typeof _.indent&&(s.indent=_.indent)},!0),s.$watch(_.indentPlus,function(e){"number"==typeof e?s.indent_plus=e:"number"==typeof _.indentPlus&&(s.indent_plus=_.indentPlus)},!0),s.$watch(_.dragDelay,function(e){"number"==typeof e?s.dragDelay=e:"number"==typeof _.dragDelay&&(s.dragDelay=_.dragDelay)},!0),s["class"]={},angular.extend(s["class"],o);var u,p,g,f;angular.extend(s["class"].icon,{1:_.iconExpand||"glyphicon glyphicon-minus",0:_.iconCollapse||"glyphicon glyphicon-plus","-1":_.iconLeaf||"glyphicon glyphicon-file"}),_.expandLevel=_.expandLevel?_.expandLevel:"3",p=parseInt(_.expandLevel,10),s.treeData||(s.treeData=[]);var h=function(){if(s.treeData.length){var e,n,t=s.treeData[0],a=Object.keys(t),l=new RegExp("^__([a-zA-Z0-9_-]*)__$");for(e=0,n=a.length;n>e;e++)if("string"==typeof t[a[e]]&&!l.test(a[e])){u=a[e];break}u||(u=a[0]),s.expandingProperty=u}},m=function(){if(s.treeData.length){var e,n=[],t=s.treeData[0],a=Object.keys(t),l=new RegExp("(^__([a-zA-Z0-9_-]*)__$|^"+u+"$)"),r=a.length;for(e=0;r>e;e++)l.test(a[e])||n.push({field:a[e]});s.colDefinitions=n}};_.expandOn&&(u=s.expandOn||[],s.expandingProperty=s.expandOn||[]),_.columnDefs&&(angular.isArray(s.columnDefs)?s.colDefinitions=s.columnDefs:m());var b=function(e,n,t,a,l,r,o){var d,i,c,_,u,g;if(angular.isArray(n.__children__)||(n.__children__=[]),n.__parent_real__=a,n.__parent__=t,i=n.__children__.length,null===n.__expanded__&&i>0&&(n.__expanded__=p>l),c=0===i?-1:n.__expanded__?1:0,_=e.length,n.__index__=o,n.__index_real__=_,n.__level__=l,n.__icon__=c,n.__visible__=r,null===n.__uid__&&(n.__uid__=""+Math.random()),e.push(n),u=1,i>0)for(d=0;i>d;d++)u+=b(e,n.__children__[d],"__uid__"===s.primary_key?n.__uid__:n[s.primary_key],_,l+1,r&&n.__expanded__,d);return g=s.getHash(n),(null===n.__hashKey__||n.__hashKey__!==g)&&(n.__hashKey__=g),n.__dept__=u,u},v=function(){_.expandOn||h(),_.columnDefs||m();var e=s.treeData,n=e.length,t=[];if(n>0){var a,l,r,o,d,i=0;for(a=0;n>a;a++)i+=b(t,e[a],null,null,1,!0,a);if(d=Object.keys(s.$globals),n=s.$globals.length,l=n-i,0!==l)for(r=n-l,o=r-Math.abs(l),a=o;r>a;a++)delete s.$globals[d[a]]}return s.tree_nodes=t,s.tree_nodes};s.onClick=function(n){angular.isFunction(s.on_click)&&e(function(){s.on_click({node:n})})},s.onSelect=function(e){e!==f.selected_node&&f.select_node(e)},s.$watch("treeData",v,!0),v(),s.tree&&angular.isObject(s.tree)||(s.tree={}),f={selected_node:null,for_all_descendants:s.for_all_descendants,select_node:function(n){return n?(n!==f.selected_node&&(f.selected_node&&delete f.selected_node.__selected__,n.__selected__=!0,f.selected_node=n,f.expand_all_parents(n),angular.isFunction(s.on_select)&&e(function(){s.on_select({node:n})})),n):(f.selected_node&&delete f.selected_node.__selected__,f.selected_node=null,null)},deselect_node:function(){var e=null;return f.selected_node&&(delete f.selected_node.__selected__,e=f.selected_node,f.selected_node=null),e},get_parent:function(e){return e&&e.__parent_real__>-1?s.tree_nodes[e.__parent_real__]:null},for_all_ancestors:function(e,n){var t;return t=f.get_parent(e),t?n(t)?!1:f.for_all_ancestors(t,n):!0},expand_all_parents:function(e){return f.for_all_ancestors(e,function(e){e.__expanded__=!0})},reload_data:function(){return v()},add_node:function(e,n,t){return"number"!=typeof t?e?(e.__children__.push(n),e.__expanded__=!0):s.treeData.push(n):e?(e.__children__.splice(t,0,n),e.__expanded__=!0):s.treeData.splice(t,0,n),n},add_node_root:function(e){return f.add_node(null,e),e},expand_all:function(){var e=0,n=s.treeData.length;for(e=0;n>e;e++)f.for_all_descendants(s.treeData[e],function(e){e.__expanded__=!0})},collapse_all:function(){var e=0,n=s.treeData.length;for(e=0;n>e;e++)f.for_all_descendants(s.treeData[e],function(e){e.__expanded__=!1})},remove_node:function(e){if(e=e||f.selected_node){var n;n=e.__parent_real__?f.get_parent(e).__children__:s.treeData,n.splice(e.__index__,1),f.selected_node===e&&(f.selected_node=null)}},expand_node:function(e){return e||(e=f.selected_node),e?(e.__expanded__=!0,e):void 0},collapse_node:function(e){return e||(e=f.selected_node),e?(e.__expanded__=!1,e):void 0},get_selected_node:function(){return f.selected_node},get_first_node:function(){return g=s.treeData.length,g>0?s.treeData[0]:null},get_children:function(e){return e.__children__},get_siblings:function(e){var n,t;return e||(e=f.selected_node),e?(n=f.get_parent(e),t=n?n.__children__:s.treeData):void 0},get_next_sibling:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_siblings(e),g=n.length,e.__index__<g)?n[e.__index__+1]:void 0},get_prev_sibling:function(e){var n;return e||(e=f.selected_node),n=f.get_siblings(e),e.__index__>0?n[e.__index__-1]:void 0},get_first_child:function(e){var n;return e||(e=f.selected_node),e&&((n=e.__children__)?n.length:void 0)>0?e.__children__[0]:null},get_closest_ancestor_next_sibling:function(e){var n,t;return n=f.get_next_sibling(e),n?n:(t=f.get_parent(e),f.get_closest_ancestor_next_sibling(t))},get_next_node:function(e){var n;return e||(e=f.selected_node),e?(n=f.get_first_child(e),n?n:f.get_closest_ancestor_next_sibling(e)):void 0},get_prev_node:function(e){var n,t;return e||(e=f.selected_node),e?(t=f.get_prev_sibling(e),t?f.get_last_descendant(t):n=f.get_parent(e)):void 0},get_last_descendant:function(e){var n;return e||(e=f.selected_node),g=e.__children__.length,0===g?e:(n=e.__children__[g-1],f.get_last_descendant(n))},select_parent_node:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_parent(e))?f.select_node(n):void 0},select_first_node:function(){return f.select_node(f.get_first_node())},select_next_sibling:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_next_sibling(e))?f.select_node(n):void 0},select_prev_sibling:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_prev_sibling(e))?f.select_node(n):void 0},select_next_node:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_next_node(e))?f.select_node(n):void 0},select_prev_node:function(e){var n;return e||(e=f.selected_node),e&&(n=f.get_prev_node(e))?f.select_node(n):void 0}},angular.extend(s.tree,f),f=s.tree;var y,$,D,x,C,w,E,S,k="ontouchstart"in window,T=!0,P=!1,Y=null,X=document.body,M=document.documentElement,N=function(e){if((k||2!==e.button&&3!==e.which)&&!(e.uiTreeDragging||e.originalEvent&&e.originalEvent.uiTreeDragging)){var n=angular.element(e.target),t=n.scope();if(t&&t.$type&&"TreeDnDNodeHandle"===t.$type){var r=n.prop("tagName").toLowerCase(),o=null;if("input"!==r&&"textarea"!==r&&"button"!==r&&"select"!==r){for(;n&&n[0]&&n[0]!==c;){if(d.nodrag(n))return;n=n.parent()}if(e.uiTreeDragging=!0,e.originalEvent&&(e.originalEvent.uiTreeDragging=!0),e.preventDefault(),o=t.getScopeNode(),y=!0,s.$callbacks.beforeDrag(o)){var i=d.eventObj(e),_=o.$element.prop("tagName").toLowerCase(),u="tr"===_;$=d.dragInfo(o),s.setDragging($),D=d.positionStarted(i,o.$element),C=u?angular.element(a.document.createElement("table")).addClass(s["class"].tree).addClass(s["class"].drag).addClass(s.tree_class):angular.element(a.document.createElement("ul")).addClass(s["class"].drag).addClass("tree-dnd-nodes").addClass(s.tree_class),C.css({width:d.width(o.$element)+"px","z-index":9995}),S=0;var p=d.width(o.$element),g=o,f=g.$element,h=f.clone();if(u){S=$.node.__level__-1;var m=angular.element(a.document.createElement("tbody"));s.for_all_descendants($.node,function(e){g=s.getScope(e),f=g.$element,h=f.clone(),d.replaceIndent(g,h,e.__level__-S,"padding-left"),m.append(h),s.enabledMove&&s["class"].hidden&&f.addClass(s["class"].hidden)}),C.append(m)}else C.append(h),s.enabledMove&&s["class"].hidden&&f.addClass(s["class"].hidden);C.css({left:i.pageX-D.offsetX+s.$callbacks.calsIndent(S+1,!0,!0)+"px",top:i.pageY-D.offsetY+"px"}),l.find("body").append(C),x=s.initPlace(o.$element,C),u&&d.replaceIndent(s,x,$.node.__level__),s.showPlace(),x.css("width",p),s.enabledStatus&&(s.refreshStatus(),s.setPositionStatus(e)),angular.element(l).bind("touchend",I),angular.element(l).bind("touchcancel",I),angular.element(l).bind("touchmove",O),angular.element(l).bind("mouseup",I),angular.element(l).bind("mousemove",O),angular.element(l).bind("mouseleave",B),w=Math.max(X.scrollHeight,X.offsetHeight,M.clientHeight,M.scrollHeight,M.offsetHeight),E=Math.max(X.scrollWidth,X.offsetWidth,M.clientWidth,M.scrollWidth,M.offsetWidth)}}}}},A=function(e){if(!P)return void(T||(P=!0,$.drag.$apply(function(){$.drag.$callbacks.dragStart($)})));if(C){e.preventDefault(),a.getSelection?a.getSelection().removeAllRanges():a.document.selection&&a.document.selection.empty();var n=d.eventObj(e),t=n.pageX-D.offsetX,l=n.pageY-D.offsetY;0>t&&(t=0),0>l&&(l=0),l+10>w&&(l=w-10),t+10>E&&(t=E-10),C.css({left:t+$.drag.$callbacks.calsIndent(S+1,!0,!0)+"px",top:l+"px"}),s.enabledStatus&&s.setPositionStatus(e);var r=window.pageYOffset||a.document.documentElement.scrollTop,o=r+(window.innerHeight||a.document.clientHeight||a.document.clientHeight);if(o<n.pageY&&w>=o&&window.scrollBy(0,10),r>n.pageY&&window.scrollBy(0,-10),d.positionMoved(e,D,y),y)return void(y=!1);var i=n.pageX-a.document.body.scrollLeft,c=n.pageY-(window.pageYOffset||a.document.documentElement.scrollTop),_=angular.element(a.document.elementFromPoint(i,c)),u=_.scope(),p=null,g=null,f=!1,h=!0,m=!0,b=!1,v=!1,k=null,Y=null,X=$.move,M=1,N=$.node,A=$.drop,H=$.target,L=function(){if(H=u.getScopeTree(),$.target!==H){if(!H.$callbacks.droppable())return!1;$.target.hidePlace(),$.target=H,x=H.initPlace(u.$element,C),v=!0}return!0};if(!u)return;if(u.getScopeNode){if(u=u.getScopeNode(),!L())return}else{if("TreeDnDNodes"!==u.$type&&"TreeDnD"!==u.$type)return;if(!u.tree_nodes)return;if(u.tree_nodes.length)u=$.scope,m=!1;else{if(!L())return;b=!0}}if(D.dirAx&&!v&&(m=!1,u=$.scope),!u.$element&&!u)return;if(b)g=u.$element.prop("tagName").toLowerCase(),f="tbody"===g||"table"===g||"tr"===g||"td"===g,X={parent:null,pos:0},A=null;else if(g=u.$element.prop("tagName").toLowerCase(),f="tr"===g||"tbody"===g||"td"===g,m){_=u.$element;var O=d.offset(_);if(u.horizontal&&!f)p=n.pageX<O.left+d.width(_)/2;else if(f)p=n.pageY<O.top+d.height(_)/2;else{var I=d.height(_)-d.height(u.elementChilds);if(n.pageY>O.top+I)return;p=n.pageY<O.top+I/2}if(Y=u.getData(),j=u.getNode(Y.__parent_real__),p){var B;B=u.getPrevSibling(Y),X={parent:j,pos:null===B?0:B.__index__+1},A=B}else!Y.__expanded__||1===Y.__children__.length&&Y.__index_real__===N.__parent_real__?(X={parent:j,pos:Y.__index__+1},A=Y):(X={parent:Y,pos:0},A=null)}else{if(!(D.dirAx&&D.distAxX>=H.dragBorder))return;if(D.distAxX=0,D.distX>0){if(j=A,!j){if(!(X.pos-1>=0))return;j=X.parent.__children__[X.pos-1]}if($.drag===$.target&&j===N&&s.enabledMove&&(j=H.getPrevSibling(j)),!j||!j.__visible__)return;var K=j.__children__.length;X={parent:j,pos:K},A=K>0?j.__children__[K-1]:null}else{if(!(D.distX<0))return;if(Y=X.parent,!Y||!(0===Y.__children__.length||Y.__children__.length-1<X.pos||Y.__children__.length-1===N.__index__&&s.enabledMove))return;j=H.getNode(Y.__parent_real__),X={parent:j,pos:Y.__index__+1},A=Y}}if($.drag===$.target&&X.parent&&N.__parent_real__===X.parent.__index_real__&&N.__index__===X.pos&&(h=!1),H.$callbacks.accept($,X,h)){if($.move=X,$.drop=A,$.changed=h,$.scope=u,f)if(M=null===X.parent?1:X.parent.__level__+1,d.replaceIndent(H,x,M),A){var j=(X.parent?X.parent.__children__:null)||$.target.treeData;A.__index__<j.length-1?(A=j[A.__index__+1],k=$.target.getScope(A),k.$element[0].parentNode.insertBefore(x[0],k.$element[0])):(Y=$.target.tree.get_last_descendant(A),k=$.target.getScope(Y),k.$element.after(x))}else k=$.target.getScope(X.parent),k&&(X.parent?k.$element.after(x):k.elementChilds.prepend(x));else k=$.target.getScope(A||X.parent),A?k.$element.after(x):k.elementChilds.prepend(x);H.showPlace(),$.drag.$apply(function(){$.drag.$callbacks.dragMove($)})}}},H=function(e){if(e.preventDefault(),C){var n=!1;$.drag.$apply(function(){n=$.drag.$callbacks.beforeDrop($)});var t=s.getScope($.node),r=t.$element.prop("tagName").toLowerCase(),o=t.$element;"tr"===r?s.for_all_descendants($.node,function(e){t=s.getScope(e),o=t.$element,t["class"].hidden&&o.removeClass(s["class"].hidden)}):t["class"].hidden&&o.removeClass(s["class"].hidden),C.remove(),C=null,$.target.hidePlace(),s.enabledStatus&&s.hideStatus();var d=!1;$.drag.$apply?$.drag.$apply(function(){d=$.drag.$callbacks.dropped($,n,s.enabledMove)}):K(),$.drag.$apply(function(){$.drag.$callbacks.dragStop($,d)}),$.drag.$apply=!1,$=null,s.setDragging(null)}angular.element(l).unbind("touchend",I),angular.element(l).unbind("touchcancel",I),angular.element(l).unbind("touchmove",O),angular.element(l).unbind("mouseup",I),angular.element(l).unbind("mousemove",O),angular.element(a.document.body).unbind("mouseleave",B)},L=function(e){s.$callbacks.draggable()&&N(e)},O=function(e){A(e)},I=function(e){s.$apply=!0,H(e)},B=function(e){H(e)},K=function(){c.bind("touchstart mousedown",function(n){T=!0,P=!1,L(n),Y=e(function(){T=!1},s.dragDelay)}),c.bind("touchend touchcancel mouseup",function(){e.cancel(Y)})},j=function(e){if(27===e.keyCode)s.enabledStatus&&s.hideStatus(),s.$apply=!1,H(e);else if(s.enabledHotkey&&e.shiftKey){if(s.enableMove(!0),s.enabledStatus&&s.refreshStatus(),!$)return;var n=s.getScope($.node),t=n.$element.prop("tagName").toLowerCase(),a=n.$element;"tr"===t?s.for_all_descendants($.node,function(e){n=s.getScope(e),a=n.$element,s["class"].hidden&&a.addClass(s["class"].hidden)}):s["class"].hidden&&a.addClass(s["class"].hidden)}},z=function(e){if(s.enabledHotkey&&!e.shiftKey){if(s.enableMove(!1),s.enabledStatus&&s.refreshStatus(),!$)return;var n=s.getScope($.node),t=n.$element.prop("tagName").toLowerCase(),a=n.$element;"tr"===t?s.for_all_descendants($.node,function(e){n=s.getScope(e),a=n.$element,s["class"].hidden&&a.removeClass(s["class"].hidden)}):s["class"].hidden&&a.removeClass(s["class"].hidden)}};K(),angular.element(a.document.body).bind("keydown",j),angular.element(a.document.body).bind("keyup",z),s.$on("$destroy",function(){angular.element(a.document.body).unbind("keydown",j),angular.element(a.document.body).unbind("keyup",z),s.statusElm&&s.statusElm.remove(),s.placeElm&&s.placeElm.remove()}),n.get(_.templateUrl||r.getPath(),{cache:i}).success(function(e){c.append(t(e)(s))})}}}]).factory("$TreeDnDConvert",function(){return{line2tree:function(e,n,t){if(!e||0===e.length||!n||!t)return[];for(var a,l,r=[],o=[],d=e[0],i=d[n],s={},c=e.length,_=0;c>_;)d=e[_++],i=d[n],s[i]=d,a=d[t],a?(l=s[a],l.__children__?l.__children__.push(d):l.__children__=[d]):o.push(i);for(c=o.length,_=0;c>_;_++)r.push(s[o[_]]);return r},tree2tree:function(e,n){var t=function(e){var a,l,r,o=[],d=e.length;for(a=0;d>a;a++)l=angular.copy(e[a]),angular.isArray(l[n])&&l[n].length>0&&(r=t(l[n]),delete l[n],l.__children__=r),o.push(l);return o};return t(e)}}}).factory("$TreeDnDHelper",["$document","$window",function(e,n){return{calsIndent:null,nodrag:function(e){return"undefined"!=typeof e.attr("data-nodrag")},eventObj:function(e){var n=e;return void 0!==e.targetTouches?n=e.targetTouches.item(0):void 0!==e.originalEvent&&void 0!==e.originalEvent.targetTouches&&(n=e.originalEvent.targetTouches.item(0)),n},dragInfo:function(e){var n=e.getData(),t=e.getScopeTree(),a=e.getNode(n.__parent_real__);return{node:n,parent:a,move:{parent:a,pos:n.__index__},scope:e,target:t,drag:t,drop:e.getPrevSibling(n),changed:!1}},height:function(e){return e.prop("scrollHeight")},width:function(e){return e.prop("scrollWidth")},offset:function(t){var a=t[0].getBoundingClientRect();return{width:t.prop("offsetWidth"),height:t.prop("offsetHeight"),top:a.top+(n.pageYOffset||e[0].body.scrollTop||e[0].documentElement.scrollTop),left:a.left+(n.pageXOffset||e[0].body.scrollLeft||e[0].documentElement.scrollLeft)}},positionStarted:function(e,n){var t={};return t.offsetX=e.pageX-this.offset(n).left,t.offsetY=e.pageY-this.offset(n).top,t.startX=t.lastX=e.pageX,t.startY=t.lastY=e.pageY,t.nowX=t.nowY=t.distX=t.distY=t.dirAx=0,t.dirX=t.dirY=t.lastDirX=t.lastDirY=t.distAxX=t.distAxY=0,t},positionMoved:function(e,n,t){n.lastX=n.nowX,n.lastY=n.nowY,n.nowX=e.pageX,n.nowY=e.pageY,n.distX=n.nowX-n.lastX,n.distY=n.nowY-n.lastY,n.lastDirX=n.dirX,n.lastDirY=n.dirY,n.dirX=0===n.distX?0:n.distX>0?1:-1,n.dirY=0===n.distY?0:n.distY>0?1:-1;var a=Math.abs(n.distX)>Math.abs(n.distY)?1:0;return t?(n.dirAx=a,void(n.moving=!0)):(n.dirAx!==a?(n.distAxX=0,n.distAxY=0):(n.distAxX+=Math.abs(n.distX),0!==n.dirX&&n.dirX!==n.lastDirX&&(n.distAxX=0),n.distAxY+=Math.abs(n.distY),0!==n.dirY&&n.dirY!==n.lastDirY&&(n.distAxY=0)),void(n.dirAx=a))},replaceIndent:function(e,n,t,a){a=a?a:"left",angular.element(n.children()[0]).css(a,e.$callbacks.calsIndent(t))}}}]).factory("$TreeDnDTemplate",["$templateCache",function(e){var n="template/TreeDnD/TreeDnD.html",t="template/TreeDnD/TreeDnDStatusCopy.html",a="template/TreeDnD/TreeDnDStatusMove.html",l={};return{setMove:function(e,n){l[n.$id]||(l[n.$id]={}),l[n.$id].movePath=e},setCopy:function(e,n){l[n.$id]||(l[n.$id]={}),l[n.$id].copyPath=e},getPath:function(){return n},getCopy:function(n){var a;return l[n.$id]&&l[n.$id].copyPath&&(a=e.get(l[n.$id].copyPath))?a:e.get(t)},getMove:function(n){var t;return l[n.$id]&&l[n.$id].movePath&&(t=e.get(l[n.$id].movePath))?t:e.get(a)}}}]);angular.module("template/TreeDnD/TreeDnD.html",[]).run(["$templateCache",function(e){e.put("template/TreeDnD/TreeDnD.html",'<table ng-class="tree_class">    <thead>  <tr>     <th ng-class="expandingProperty.titleClass" ng-style="expandingProperty.titleStyle">         {{expandingProperty.displayName || expandingProperty.field || expandingProperty}}        </th>        <th ng-repeat="col in colDefinitions" ng-class="col.titleClass" ng-style="col.titleStyle">         {{col.displayName || col.field}}     </th>    </tr>    </thead> <tbody tree-dnd-nodes="tree_nodes">  <tr tree-dnd-node="node" ng-repeat="node in nodes track by node.__hashKey__ " ng-show="node.__visible__"       ng-click="onSelect(node)" ng-class="(node.__selected__ ? \' active\':\'\')">        <td ng-if="!expandingProperty.template" tree-dnd-node-handle         ng-style="expandingProperty.cellStyle ? expandingProperty.cellStyle : {\'padding-left\': $callbacks.calsIndent(node.__level__)}"          ng-class="expandingProperty.cellClass"            compile="expandingProperty.cellTemplate">              <a data-nodrag>                  <i ng-class="$icon_class" ng-click="toggleExpand(node)"                     class="tree-icon"></i>              </a>             {{node[expandingProperty.field] || node[expandingProperty]}}       </td>        <td ng-if="expandingProperty.template" compile="expandingProperty.template"></td>        <td ng-repeat="col in colDefinitions" ng-class="col.cellClass" ng-style="col.cellStyle"            compile="col.cellTemplate">            {{node[col.field]}}       </td>    </tr>    </tbody></table>'),e.put("template/TreeDnD/TreeDnDStatusCopy.html",'<label><i class="fa fa-copy"></i>&nbsp;<b>Copying</b></label>'),e.put("template/TreeDnD/TreeDnDStatusMove.html",'<label><i class="fa fa-file-text"></i>&nbsp;<b>Moving</b></label>')}])}).call();