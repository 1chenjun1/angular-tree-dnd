(function(){angular.module("template/TreeDnD/TreeDnD.html",[]).run(["$templateCache",function(a){a.put("template/TreeDnD/TreeDnD.html",'<table ng-class="tree_class">\n    <thead>\n  <tr>\n     <th ng-class="expandingProperty.titleClass" ng-style="expandingProperty.titleStyle">\n         {{expandingProperty.displayName || expandingProperty.field || expandingProperty}}\n        </th>\n        <th ng-repeat="col in colDefinitions" ng-class="col.titleClass" ng-style="col.titleStyle">\n         {{col.displayName || col.field}}\n     </th>\n    </tr>\n    </thead>\n <tbody>\n  <tr tree-dnd-node="node" ng-repeat="node in tree_nodes track by node.__hashKey__ " ng-show="node.__visible__"\n     ng-class="(node.__selected__ ? \' active\':\'\')">\n        <td ng-if="!expandingProperty.template" tree-dnd-node-handle\n         ng-style="expandingProperty.cellStyle ? expandingProperty.cellStyle : {\'padding-left\': $callbacks.calsIndent(node.__level__)}"\n          ng-click="onSelect(node)" ng-class="expandingProperty.cellClass"\n            compile="expandingProperty.cellTemplate">\n              <a data-nodrag>\n                  <i ng-class="$iconClass" ng-click="toggleExpand(node)"\n                     class="tree-icon"></i>\n              </a>\n             {{node[expandingProperty.field] || node[expandingProperty]}}\n       </td>\n        <td ng-if="expandingProperty.template" compile="expandingProperty.template"></td>\n        <td ng-repeat="col in colDefinitions" ng-class="col.cellClass" ng-style="col.cellStyle"\n            compile="col.cellTemplate">\n            {{node[col.field]}}\n       </td>\n    </tr>\n    </tbody>\n</table>');a.put("template/TreeDnD/TreeDnDStatusCopy.html",'<label><i class="fa fa-copy"></i>&nbsp;<b>Copying</b></label>');a.put("template/TreeDnD/TreeDnDStatusMove.html",'<label><i class="fa fa-file-text"></i>&nbsp;<b>Moving</b></label>')}]);angular.module("ntt.TreeDnD",["template/TreeDnD/TreeDnD.html"]).directive("compile",["$compile",function(a){return{restrict:"A",link:function(d,c,b){d.$watch(b.compile,function(e){if(e!=null){var f=a(e);var g=f(d);c.empty().append(g)}})}}}]).directive("treeDnd",["$timeout","$http","$compile","$window","$document","$TreeDnDTemplate","tgConfig","$TreeDnDHelper","$templateCache",function(c,i,h,b,f,e,g,a,d){return{restrict:"E",replace:true,scope:{treeData:"=",on_select:"&onSelect",on_click:"&onClick",tree:"=treeControl",expandOn:"=",columnDefs:"=",callbacks:"=",primaryKey:"="},controller:["$scope","$element","$attrs","tgConfig",function(l,k,j,m){l.dragEnabled=true;l.dragDelay=0;l.indent=20;l.indent_plus=15;l.indent_unit="px";l.tree_class="table";l.primary_key="__uid__";l.enabledMove=true;l.statusMove=true;l.enabledHotkey=false;l.tree_data=l.treeData;l.dragging=null;l.$globals={};l.config={};l.statusElm=null;l.placeElm=null;l.setDragging=function(n){l.dragging=n};l.toggleExpand=function(n){if(n.__children__.length>0){n.__expanded__=!n.__expanded__}};l.classIcon={};l.$callbacks={accept:function(o,n){return true},beforeDrag:function(n){return true},dragStart:function(n){},dragMove:function(n){},dragStop:function(n,o){},beforeDrop:function(n){return true},calsIndent:function(r,o,n){var q=0,p=(n)?0:l.indent_plus;if(!o){q=l.indent_unit?l.indent_unit:"px"}if(r-1<1){return p+q}else{return l.indent*(r-1)+p+q}},dragEnabled:function(){return l.dragEnabled},dropped:function(o,t,s){var v=o.node,n=null,p=o.parent||o.drag.treeData,q=o.move,r=q.parent||o.scope.treeData,u;if(r!=-1){if(s==true){u=p;if(u.__children__){u=u.__children__}n=u.splice(v.__index__,1)[0]}else{n=angular.copy(v);n.__uid__=null}if(o.drag==o.scope&&p==r&&q.pos>=o.node.__index__){q.pos--}if(q.pos>-1){u=r;if(u.__children__){u=u.__children__}u.splice(q.pos,0,n)}else{}return true}return false}};l.accept=function(o,n){return l.$callbacks.accept(o,n)};l.beforeDrag=function(n){return l.$callbacks.beforeDrag(n)};l.getPrevGlobal=function(n){if(n>0){return l.tree_nodes[n-1]}return null};l.getNextGlobal=function(n){if(n>0){return l.tree_nodes[n-1]}return null};l.getNode=function(n){if(n==null){return null}return l.tree_nodes[n]};l.getHash=function(n){if(l.primary_key=="__uid__"){return"#"+n.__parent__+"#"+n.__index__+"#"+n.__uid__}else{return"#"+n.__parent__+"#"+n.__index__+"#"+n[l.primary_key]}};l.setScope=function(n,p){var o=l.getHash(p);if(l.$globals[o]!=n){l.$globals[o]=n}};l.getScope=function(n){if(n){return l.$globals[l.getHash(n)]}else{return l}};l.enableMove=function(n){if((typeof n)==="boolean"){l.enabledMove=n}else{l.enabledMove=true}};l.setPositionStatus=function(o,n){if(l.statusElm){l.statusElm.css({left:o.pageX+10+"px",top:o.pageY+15+"px","z-index":9999});l.statusElm.addClass(l.config.statusClass)}};if(j.enableStatus){l.enabledStatus=false;l.hideStatus=function(){if(l.statusElm){l.statusElm.addClass(l.config.hiddenClass)}};l.refreshStatus=function(){if(!l.dragging){return}if(l.enabledStatus){var n=l.statusElm;if(l.enabledMove){l.statusElm=angular.element(e.getMove(l))}else{l.statusElm=angular.element(e.getCopy(l))}if(n!=l.statusElm){if(n){l.statusElm.attr("class",n.attr("class"));l.statusElm.attr("style",n.attr("style"));n.remove()}f.find("body").append(l.statusElm)}l.statusElm.removeClass(l.config.hiddenClass)}}}else{l.enabledStatus=null}l.initPlace=function(p,r,q){var o=p.prop("tagName").toLowerCase();if(!l.placeElm){if(o.toLowerCase()=="tr"){l.placeElm=angular.element(b.document.createElement("tr"));var n=l.colDefinitions.length;l.placeElm.append(angular.element(b.document.createElement("td")).addClass(l.config.emptyTreeClass).addClass("indented").addClass(l.config.placeHolderClass));while(n-->0){l.placeElm.append(angular.element(b.document.createElement("td")).addClass(l.config.emptyTreeClass).addClass(l.config.placeHolderClass))}}else{l.placeElm=angular.element(b.document.createElement("li")).addClass(l.config.emptyTreeClass).addClass(l.config.placeHolderClass)}}else{l.placeElm.removeClass(l.config.hiddenClass)}if(o.toLowerCase()=="tr"){a.replaceIndent(l,l.placeElm,r)}p[0].parentNode.insertBefore(l.placeElm[0],p[0]);l.placeElm.css("height",a.height(q)+"px");return l.placeElm};l.hidePlace=function(){if(l.placeElm){l.placeElm.addClass(l.config.hiddenClass)}};l.showPlace=function(){if(l.placeElm){l.placeElm.removeClass(l.config.hiddenClass)}}}],link:function(M,w,t){M.$type="TreeDnD";M.colDefinitions=[];M.dragging=null;M.$watch(t.enableStatus,function(n){if((typeof n)==="boolean"){M.enabledStatus=n}},true);M.$watch(t.enableMove,function(n){if((typeof n)==="boolean"){M.enabledMove=n;M.statusMove=n}},true);if(t.enableStatus){M.$watch(t.templateCopy,function(Z){var n=null;if((typeof Z)==="string"&&Z.trim().length>0){n=Z.trim()}else{n=t.templateCopy;if(n){n=n.trim();if(n.length==0&&!d.get(n)){n=null}}}if(n){if(d.get(n)){e.setCopy(n,M)}}},true);M.$watch(t.templateMove,function(Z){var n=null;if((typeof Z)==="string"&&Z.trim().length>0){n=Z.trim()}else{n=t.templateMove;if(n){n=n.trim();if(n.length==0&&!d.get(n)){n=null}}}if(n){if(d.get(n)){e.setMove(n,M)}}},true)}if(!t.primaryKey){M.primary_key=="__uid__"}else{M.$watch(t.primaryKey,function(n){if(typeof n==="string"){M.primary_key=n}else{M.primary_key=t.primaryKey}},true)}M.$watch(t.callbacks,function(n){angular.forEach(n,function(aa,Z){if(typeof aa==="function"){if(M.$callbacks[Z]){M.$callbacks[Z]=aa}}})},true);if((typeof t["class"])==="string"){M.tree_class=t["class"].trim()}if((typeof t.indentUnit)==="string"){M.indent_unit=t.indentUnit}M.$watch(t.enableHotkey,function(n){if((typeof n)==="boolean"){M.enabledHotkey=n}if(M.enabledHotkey){M.enabledMove=false}else{M.enabledMove=M.statusMove}},true);M.$watch(t.enableDrag,function(n){if((typeof n)==="boolean"){M.dragEnabled=n}else{if((typeof t.enableDrag)=="boolean"){M.indent=t.enableDrag}}},true);M.$watch(t.indent,function(n){if((typeof n)=="number"){M.indent=n}else{if((typeof t.indent)=="number"){M.indent=t.indent}}},true);M.$watch(t.indentPlus,function(n){if((typeof n)=="number"){M.indent_plus=n}else{if((typeof t.indentPlus)=="number"){M.indent_plus=t.indentPlus}}},true);M.$watch(t.dragDelay,function(n){if((typeof n)=="number"){M.dragDelay=n}else{if((typeof t.dragDelay)=="number"){M.dragDelay=t.dragDelay}}},true);M.config={};angular.extend(M.config,g);M.$watch(t.config,function(n){angular.extend(M.config,n)},true);var k,D,P,C;M.classIcon={"1":t.iconExpand?t.iconExpand:"glyphicon glyphicon-minus","0":t.iconCollapse?t.iconCollapse:"glyphicon glyphicon-plus","-1":t.iconLeaf?t.iconLeaf:"glyphicon glyphicon-file"};t.expandLevel=t.expandLevel?t.expandLevel:"3";D=parseInt(t.expandLevel,10);if(!M.treeData){M.treeData=[]}var X=function(){if(M.treeData.length){var ac=M.treeData[0],aa=Object.keys(ac),ab=new RegExp("^__([a-zA-Z0-9_-]*)__$");for(var Z=0,n=aa.length;Z<n;Z++){if(typeof(ac[aa[Z]])==="string"&&!ab.test(aa[Z])){k=aa[Z];break}}if(!k){k=aa[0]}M.expandingProperty=k}},p=function(){if(M.treeData.length){var Z=[],ab=M.treeData[0];var aa=new RegExp("(^__([a-zA-Z0-9_-]*)__$|^"+k+"$)");for(var n in ab){if(!aa.test(n)){Z.push({field:n})}}M.colDefinitions=Z}};if(t.expandOn){k=M.expandOn||[];M.expandingProperty=M.expandOn||[]}if(t.columnDefs){if(!(angular.isArray(M.columnDefs))){p()}else{M.colDefinitions=M.columnDefs}}M.tree_nodes=[];var T=null,V=function(ac){var Z,ab,n,aa;Z=function(ae,ah){ac(ae,ah);if(ae.__children__!=null){var ag,ad,af;af=ae.__children__;for(ag=0,ad=af.length;ag<ad;ag++){Z(af[ag],ah+1)}}};aa=M.treeData;for(ab=0,n=aa.length;ab<n;ab++){Z(aa[ab],1)}},Q=function(n){if(!n){if(T!=null){T.__selected__=false}T=null;return}if(n!==T){if(T!=null){T.__selected__=false}n.__selected__=true;T=n;z(n);if(angular.isFunction(M.on_select)){return c(function(){return M.on_select({node:n})})}}},W=function(n){if(n.__parent_real__!==null&&n.__parent_real__>-1&&n.__parent_real__<M.tree_nodes.length){return M.tree_nodes[n.__parent_real__]}return null},y=function(aa,Z){var n;n=W(aa);if(n!=null){Z(n);return y(n,Z)}},z=function(n){return y(n,function(Z){return Z.__expanded__=true})},m=function(){if(!t.expandOn){X()}if(!t.columnDefs){p()}var n=M.treeData,ac=n.length,ad=[];if(ac>0){var Z,aa=function(aj,aq,am,ah,ai,an){var ak,ap,al;if(!angular.isArray(aj.__children__)){aj.__children__=[]}aj.__parent_real__=am;aj.__parent__=aq;ap=aj.__children__.length;if(aj.__expanded__==null&&ap>0){aj.__expanded__=ah<D}if(ap===0){al=-1}else{if(aj.__expanded__){al=1}else{al=0}}var at=ad.length;aj.__index__=an;aj.__index_real__=at;aj.__level__=ah;aj.__icon__=al;aj.__visible__=ai;if(aj.__uid__==null){aj.__uid__=""+Math.random()}ad.push(aj);var ao=1;if(ap>0){for(ak=0;ak<ap;ak++){ao+=aa(aj.__children__[ak],(M.primary_key=="__uid__")?aj.__uid__:aj[M.primary_key],at,ah+1,ai&&aj.__expanded__,ak)}}var ar;if(M.primary_key=="__uid__"){ar="#"+am+"#"+at+"#"+aj.__uid__}else{ar="#"+am+"#"+at+"#"+aj[M.primary_key]}if(aj.__hashKey__==null||aj.__hashKey__!=ar){aj.__hashKey__=ar;delete (M.$globals[ar])}aj.__dept__=ao;return ao},af=0;for(Z=0;Z<ac;Z++){af+=aa(n[Z],null,null,1,true,Z)}var ae,ag,ab=Object.keys(M.$globals);ac=M.$globals.length;ae=ac-af;if(ae!=0){ag=ac-ae;_min=ag-Math.abs(ae);for(Z=_min;Z<ag;Z++){delete (M.$globals[ab[Z]])}}}M.tree_nodes=ad;return M.tree_nodes};M.onClick=function(n){if(angular.isFunction(M.on_click)){c(function(){M.on_click({node:n})})}};M.onSelect=function(n){if(n!==T){Q(n)}};M.$watch("treeData",m,true);m();if(M.tree==null||!angular.isObject(M.tree)){M.tree={}}C=M.tree;C.expand_all=function(){V(function(n,Z){n.__expanded__=true})};C.collapse_all=function(){V(function(n,Z){n.__expanded__=false})};C.get_first_node=function(){P=M.treeData.length;if(P>0){return M.treeData[0]}return null};C.select_first_node=function(){var n;n=C.get_first_node();return C.select_node(n)};C.get_selected_node=function(){return T};C.get_parent_node=function(n){return W(n)};C.select_node=function(n){Q(n);return n};C.get_children=function(n){return n.__children__};C.select_parent_node=function(n){var Z;if(n==null){n=C.get_selected_node()}if(n!=null){Z=C.get_parent_node(n);if(Z!=null){C.select_node(Z);return Z}}};C.add_node=function(Z,aa,n){if((typeof n)!="number"){if(Z!=null){Z.__children__.push(aa);Z.__expanded__=true}else{M.treeData.push(aa)}}else{if(Z!=null){Z.__children__.splice(n,0,aa);Z.__expanded__=true}else{M.treeData.splice(n,0,aa)}}return aa};C.add_root_node=function(n){C.add_node(null,n);return n};C.remove_node=function(aa){aa=aa||C.get_selected_node();if(aa){var Z;if(aa.__parent_real__!==null){Z=C.get_parent_node(aa).__children__}else{Z=M.treeData}var n=Z.indexOf(aa);Z.splice(n,1);T=null}};C.expand_node=function(n){if(n==null){n=C.get_selected_node()}if(n!=null){n.__expanded__=true;return n}};C.collapse_node=function(n){if(n==null){n=T}if(n!=null){n.__expanded__=false;return n}};C.get_siblings=function(n){var Z,aa;if(n==null){n=T}if(n!=null){Z=C.get_parent_node(n);if(Z){aa=Z.__children__}else{aa=M.treeData}return aa}};C.get_next_sibling=function(Z){var n,aa;if(Z==null){Z=T}if(Z!=null){aa=C.get_siblings(Z);P=aa.length;n=aa.indexOf(Z);if(n<P){return aa[n+1]}}};C.get_prev_sibling=function(Z){var n,aa;if(Z==null){Z=T}aa=C.get_siblings(Z);P=aa.length;n=aa.indexOf(Z);if(n>0){return aa[n-1]}};C.select_next_sibling=function(Z){var n;if(Z==null){Z=T}if(Z!=null){n=C.get_next_sibling(Z);if(n!=null){return C.select_node(n)}}};C.select_prev_sibling=function(Z){var n;if(Z==null){Z=T}if(Z!=null){n=C.get_prev_sibling(Z);if(n!=null){return C.select_node(n)}}};C.get_first_child=function(n){var Z;if(n==null){n=T}if(n!=null){if(((Z=n.__children__)!=null?Z.length:void 0)>0){return n.__children__[0]}}};C.get_closest_ancestor_next_sibling=function(aa){var Z,n;Z=C.get_next_sibling(aa);if(Z!=null){return Z}else{n=C.get_parent_node(aa);return C.get_closest_ancestor_next_sibling(n)}};C.get_next_node=function(Z){var n;if(Z==null){Z=T}if(Z!=null){n=C.get_first_child(Z);if(n!=null){return n}else{n=C.get_closest_ancestor_next_sibling(Z);return n}}};C.select_next_node=function(Z){var n;if(Z==null){Z=T}if(Z!=null){n=C.get_next_node(Z);if(n!=null){C.select_node(n);return n}}};C.last_descendant=function(Z){var n;if(Z==null){}P=Z.__children__.length;if(P===0){return Z}else{n=Z.__children__[P-1];return C.last_descendant(n)}};C.get_prev_node=function(Z){var n,aa;if(Z==null){Z=T}if(Z!=null){aa=C.get_prev_sibling(Z);if(aa!=null){return C.last_descendant(aa)}else{n=C.get_parent_node(Z);return n}}};C.reload_data=function(){return m()};C.select_prev_node=function(Z){var n;if(Z==null){Z=T}if(Z!=null){n=C.get_prev_node(Z);if(n!=null){C.select_node(n);return n}}};var B="ontouchstart" in window,l,S,N,J,o,E,Y=true,K=false,v=null,F=document.body,H=document.documentElement,A,O,s,q=function(ae){if(!B&&(ae.button==2||ae.which==3)){return}if(ae.uiTreeDragging||(ae.originalEvent&&ae.originalEvent.uiTreeDragging)){return}var ah=angular.element(ae.target);var ac=ah.scope();if(!ac||!ac.$type){return}if(ac.$type!="TreeDnDNode"&&ac.$type!="TreeDnDNodeHandle"){return}if(ac.$type!="TreeDnDNodeHandle"){return}var aa=ah.prop("tagName").toLowerCase(),ag=null;if(aa=="input"||aa=="textarea"||aa=="button"||aa=="select"){return}while(ah&&ah[0]&&ah[0]!=w){if(a.nodrag(ah)){return}ah=ah.parent()}ag=ac.getScopeNode();if(!M.beforeDrag(ag)){return}ae.uiTreeDragging=true;if(ae.originalEvent){ae.originalEvent.uiTreeDragging=true}ae.preventDefault();var af=a.eventObj(ae);S=true;N=a.dragInfo(ag);M.setDragging(N);var Z=ag.$element.prop("tagName").toLowerCase();J=a.positionStarted(af,ag.$element);if(Z==="tr"){E=angular.element(b.document.createElement("table")).addClass(M.config.treeClass).addClass(M.config.dragClass).addClass(M.tree_class)}else{E=angular.element(b.document.createElement("ul")).addClass(M.config.dragClass).addClass("tree-dnd-nodes").addClass(M.tree_class)}E.css({width:a.width(ag.$element)+"px","z-index":9995});s=0;var ab=a.width(ag.$element);if(Z=="tr"){var ad=angular.element(b.document.createElement("tbody"));s=ag.getData().__level__-1;var n=function(am){var ai,ak,an,aj,ao,al;ai=M.getScope(am);ak=ai.$element;al=ak.clone();a.replaceIndent(ai,al,am.__level__-s,"padding-left");ad.append(al);if(M.config.hiddenClass){ak.addClass(M.config.hiddenClass)}ao=am.__children__;aj=ao.length;for(an=0;an<aj;an++){n(ao[an])}};n(ag.getData());E.append(ad)}else{E.append(ag.$element.clone());if(M.config.hiddenClass){ag.$element.addClass(M.config.hiddenClass)}}E.css({left:af.pageX-J.offsetX+M.$callbacks.calsIndent(s+1,true,true)+"px",top:af.pageY-J.offsetY+"px"});f.find("body").append(E);o=M.initPlace(ag.$element,N.level,E);o.css("width",ab);if(M.enabledStatus){M.refreshStatus();M.setPositionStatus(ae)}angular.element(f).bind("touchend",L);angular.element(f).bind("touchcancel",L);angular.element(f).bind("touchmove",U);angular.element(f).bind("mouseup",L);angular.element(f).bind("mousemove",U);angular.element(f).bind("mouseleave",G);A=Math.max(F.scrollHeight,F.offsetHeight,H.clientHeight,H.scrollHeight,H.offsetHeight);O=Math.max(F.scrollWidth,F.offsetWidth,H.clientWidth,H.scrollWidth,H.offsetWidth)},r=function(aq){if(!K){if(!Y){K=true;M.$apply(function(){M.$callbacks.dragStart(N)})}return}var n=a.eventObj(aq);var an,au,af;if(E){aq.preventDefault();if(b.getSelection){b.getSelection().removeAllRanges()}else{if(b.document.selection){b.document.selection.empty()}}au=n.pageX-J.offsetX;af=n.pageY-J.offsetY;if(au<0){au=0}if(af<0){af=0}if((af+10)>A){af=A-10}if((au+10)>O){au=O-10}E.css({left:au+M.$callbacks.calsIndent(s+1,true,true)+"px",top:af+"px"});if(M.enabledStatus){M.setPositionStatus(aq)}var ac=window.pageYOffset||b.document.documentElement.scrollTop;var ah=ac+(window.innerHeight||b.document.clientHeight||b.document.clientHeight);if(ah<n.pageY&&ah<=A){window.scrollBy(0,10)}if(ac>n.pageY){window.scrollBy(0,-10)}a.positionMoved(aq,J,S);if(S){S=false;return}var ak=n.pageX-b.document.body.scrollLeft;var aj=n.pageY-(window.pageYOffset||b.document.documentElement.scrollTop);var ab=angular.element(b.document.elementFromPoint(ak,aj)),ao=ab.scope(),Z=null,ag=false;if(ao&&angular.isFunction(ao.getScopeNode)){ao=ao.getScopeNode();Z=ao.$element.prop("tagName").toLowerCase();if(N.scope!==ao){N.scope.hidePlace();N.scope=ao;N.scope.showPlace();ag=true}}if(!J.dirAx||ag){if(!ao){return}ab=ao.$element;var ad,at=a.offset(ab);if(Z=="tr"){ad=n.pageY<(at.top+a.height(ab)/2)}else{var av=a.height(ab)-a.height(ao.elementChilds);if(n.pageY>at.top+av){return}ad=n.pageY<(at.top+av/2)}o=ao.initPlace(ab,N.level,E);o.css("width",a.width(ab));if(ao.$callbacks.dragEnabled()){if(ao.accept(N,ad)){N.level=ao.getData().__level__;if(ad){var ai=ao.getData(),ap=ao.getNode(ai.__parent_real__),ae;if(N.drag==ao&&N.isDirty(ao.getData().__index_real__-1)){ae=ao.getPrevGlobal(N.node.__index_real__)}else{ae=ao.prev()}N.target=ae;N.scope=ao;if(N.drag==ao&&ap.__index_real__&&N.node.__parent_real__){N.move={parent:-1,pos:-1}}else{N.move={parent:ap,pos:(ap==ae)?0:ae.__index__+1}}if(Z=="tr"){a.replaceIndent(ao,o,N.level)}ab[0].parentNode.insertBefore(o[0],ab[0])}else{var am=N.level,aa=false;ai=ao.getData();N.target=ai;N.scope=ao;if(N.drag==ao&&N.parent.__index_real__==ai.__index_real__&&N.node.__index__==0){aa=true}if(ai.__expanded__&&!aa){N.level=++am;N.move={parent:ai,pos:0};if(Z=="tr"){a.replaceIndent(ao,o,am);ab.after(o)}else{ao.elementChilds.prepend(o)}}else{if(aa){N.move={parent:-1,pos:-1}}else{ap=ao.getNode(ai.__parent_real__);N.move={parent:ap,pos:ai.__index__+1}}if(Z=="tr"){a.replaceIndent(ao,o,am)}ab.after(o)}}}}}else{ao=N.scope;Z=ao.$element.prop("tagName").toLowerCase();if(J.dirAx&&J.distAxX>=ao.config.levelThreshold){J.distAxX=0;ai=N.target;if(ai){if(J.distX>0){var al=ao.visible(ai),ar;if(al&&al.__level__>=N.level){ap=al;while(ap.__level__>N.level){ap=ao.getNode(ap.__parent_real__)}ar=ap.__children__.length;N.level++;if(N.drag==ao&&N.parent==ap&&N.node.__index__>=ar-1){N.target=al;N.move={parent:-1,pos:-1}}else{N.move={parent:ap,pos:ar}}if(Z=="tr"){a.replaceIndent(ao,o,N.level)}else{_scope=ao.getScope(al);_scope.elementChilds.append(o)}}}else{if(J.distX<0){var ai=N.canIndent();ap=ao.getNode(ai.__parent_real__);if(ai==null||ai){N.level--;if(N.drag==ao&&N.parent==ap&&N.node.__index__==ai.__index__+1){N.move={parent:-1,pos:-1}}else{N.move={parent:ap,pos:ai.__index__+1}}if(Z=="tr"){a.replaceIndent(ao,o,N.level)}else{_scope=ao.getScope(ai);_scope.$element.after(o)}}}}}}}M.$apply(function(){M.$callbacks.dragMove(N)})}},R=function(ac){ac.preventDefault();if(E){var Z=false;M.$apply(function(){Z=M.$callbacks.beforeDrop(N)});var aa=N.drag.$element.prop("tagName").toLowerCase();if(aa=="tr"){var n=function(ag){var ad,af,ah,ae,ai;ad=M.getScope(ag);af=ad.$element;if(M.config.hiddenClass){af.removeClass(M.config.hiddenClass)}ai=ag.__children__;ae=ai.length;for(ah=0;ah<ae;ah++){n(ai[ah])}};n(N.drag.getData())}else{if(M.config.hiddenClass){N.drag.$element.removeClass(M.config.hiddenClass)}}E.remove();E=null;N.scope.hidePlace();if(M.enabledStatus!==null){M.hideStatus()}var ab=false;if(M.$$apply){M.$apply(function(){ab=M.$callbacks.dropped(N,Z,M.enabledMove)})}else{x()}M.$apply(function(){M.$callbacks.dragStop(N,ab)});M.$$apply=false;N=null;M.setDragging(null)}angular.element(f).unbind("touchend",L);angular.element(f).unbind("touchcancel",L);angular.element(f).unbind("touchmove",U);angular.element(f).unbind("mouseup",L);angular.element(f).unbind("mousemove",U);angular.element(b.document.body).unbind("mouseleave",G)},u=function(n){if(M.$callbacks.dragEnabled()){q(n)}},U=function(n){r(n)},L=function(n){M.$$apply=true;M.dragEnd(n)},G=function(n){M.dragEnd(n)},x=function(){w.bind("touchstart mousedown",function(n){Y=true;K=false;u(n);v=c(function(){Y=false},M.dragDelay)});w.bind("touchend touchcancel mouseup",function(){c.cancel(v)})},I=function(n){if(n.keyCode==27){if(M.enabledStatus!==null){M.hideStatus()}M.$$apply=false;M.dragEnd(n)}else{if(M.enabledHotkey&&n.shiftKey){M.enableMove(true);if(M.enabledStatus){M.refreshStatus()}}}},j=function(n){if(M.enabledHotkey&&!n.shiftKey){M.enableMove(false);if(M.enabledStatus){M.refreshStatus()}}};M.dragEnd=function(n){R(n)};x();angular.element(b.document.body).bind("keydown",I);angular.element(b.document.body).bind("keyup",j);M.$on("$destroy",function(){angular.element(b.document.body).unbind("keydown",I);angular.element(b.document.body).unbind("keyup",j);if(M.statusElm){M.statusElm.remove()}if(M.placeElm){M.placeElm.remove()}});i.get(t.templateUrl||e.getPath(),{cache:d}).success(function(n){w.append(h(n)(M))})}}}]).directive("treeDndNode",["$window","$document","$timeout","$TreeDnDHelper","$TreeDnDTemplate",function(e,d,a,b,c){return{restrict:"A",replace:true,controller:["$scope","$element","$attrs","tgConfig",function(h,g,f,i){h.$modelValue=null;h.$scopeChildren=null;h.elementChilds=null;h.prev=function(){return h.getPrevGlobal(h.$modelValue.__index_real__)};h.getData=function(){return h.$modelValue};h.visible=function(j){if(j!=null){return j.__visible__?j:h.visible(h.tree_nodes[j.__parent_real__])}return null};h.setElementChilds=function(j){h.elementChilds=j};h.getScopeNode=function(){return h}}],link:function(h,g,f){h.$element=g;h.$type="TreeDnDNode";h.$iconClass="";if(h.config.nodeClass){g.addClass(h.config.nodeClass)}h.$watch(f.treeDndNode,function(k,i,j){j.setScope(j,k);j.$modelValue=k;j.$iconClass=j.classIcon[k.__icon__]},true)}}}]).directive("treeDndNodes",function(){return{restrict:"A",replace:true,link:function(c,b,a){c.$type="TreeDnDNodes";c.$element=b;c.nodes=[];if(c.setElementChilds){c.setElementChilds(b)}c.$watch(a.treeDndNodes,function(f,d,e){e.nodes=f},true);if(c.config.nodesClass){b.addClass(c.config.nodesClass)}}}}).directive("treeDndNodeHandle",function(){return{restrict:"A",scope:true,link:function(c,b,a){c.$element=b;c.$type="TreeDnDNodeHandle";if(c.config.handleClass){b.addClass(c.config.handleClass)}}}}).factory("$TreeDnDTemplate",["$templateCache",function(a){var d="template/TreeDnD/TreeDnD.html";var c="template/TreeDnD/TreeDnDStatusCopy.html";var e="template/TreeDnD/TreeDnDStatusMove.html";var b={};return{setMove:function(g,f){if(!b[f.$id]){b[f.$id]={}}b[f.$id].movePath=g},setCopy:function(g,f){if(!b[f.$id]){b[f.$id]={}}b[f.$id].copyPath=g},getPath:function(){return d},getCopy:function(g){var f;if(b[g.$id]&&b[g.$id].copyPath&&(f=a.get(b[g.$id].copyPath))){return f}return a.get(c)},getMove:function(g){var f;if(b[g.$id]&&b[g.$id].movePath&&(f=a.get(b[g.$id].movePath))){return f}return a.get(e)}}}]).factory("$TreeDnDHelper",["$document","$window",function(b,a){return{calsIndent:null,nodrag:function(c){return(typeof c.attr("data-nodrag"))!="undefined"},eventObj:function(d){var c=d;if(d.targetTouches!==undefined){c=d.targetTouches.item(0)}else{if(d.originalEvent!==undefined&&d.originalEvent.targetTouches!==undefined){c=d.originalEvent.targetTouches.item(0)}}return c},dragInfo:function(d){var c=d.getData();return{node:c,parent:d.getNode(c.__parent_real__),level:c.__level__,target:d.prev(),scope:d,drag:d,move:{parent:-1,pos:-1},isDirty:function(e){return this.node.__index_real__<=e&&e<=this.node.__index_real__+this.node.__dept__-1},canIndent:function(){if(this.level==1){return false}var e=this.target;var f=e;while(e){if(e.__level__<this.level){if(e.__expanded__){if(e.__children__.length==0){return e}else{if((e.__index_real__==this.target.__parent_real__&&e.__children__.length-1==this.target.__index__)||(e.__index_real__==f.__parent_real__&&e.__children__.length-1==f.__index__)||(this.drag==this.scope&&e.__index_real__==this.node.__parent_real__&&e.__children__.length-1==this.node.__index__)){return e}}return false}return e}else{if(e.__parent_real__==null){return null}else{f=e;e=this.scope.tree_nodes[e.__parent_real__]}}}return false},canInsert:function(e){if(e.__children__.length==0){return true}else{if((e.__index_real__==this.target.__parent_real__&&e.__children__.length-1==this.target.__index__)||(e.__index_real__==this.node.__parent_real__&&e.__children__.length-1==this.node.__index__)){return e}}return false}}},height:function(c){return c.prop("scrollHeight")},width:function(c){return c.prop("scrollWidth")},offset:function(c){var d=c[0].getBoundingClientRect();return{width:c.prop("offsetWidth"),height:c.prop("offsetHeight"),top:d.top+(a.pageYOffset||b[0].body.scrollTop||b[0].documentElement.scrollTop),left:d.left+(a.pageXOffset||b[0].body.scrollLeft||b[0].documentElement.scrollLeft)}},positionStarted:function(d,c){var f={};f.offsetX=d.pageX-this.offset(c).left;f.offsetY=d.pageY-this.offset(c).top;f.startX=f.lastX=d.pageX;f.startY=f.lastY=d.pageY;f.nowX=f.nowY=f.distX=f.distY=f.dirAx=0;f.dirX=f.dirY=f.lastDirX=f.lastDirY=f.distAxX=f.distAxY=0;return f},positionMoved:function(f,g,d){g.lastX=g.nowX;g.lastY=g.nowY;g.nowX=f.pageX;g.nowY=f.pageY;g.distX=g.nowX-g.lastX;g.distY=g.nowY-g.lastY;g.lastDirX=g.dirX;g.lastDirY=g.dirY;g.dirX=g.distX===0?0:g.distX>0?1:-1;g.dirY=g.distY===0?0:g.distY>0?1:-1;var c=Math.abs(g.distX)>Math.abs(g.distY)?1:0;if(d){g.dirAx=c;g.moving=true;return}if(g.dirAx!==c){g.distAxX=0;g.distAxY=0}else{g.distAxX+=Math.abs(g.distX);if(g.dirX!==0&&g.dirX!==g.lastDirX){g.distAxX=0}g.distAxY+=Math.abs(g.distY);if(g.dirY!==0&&g.dirY!==g.lastDirY){g.distAxY=0}}g.dirAx=c},replaceIndent:function(f,e,d,c){c=c?c:"left";angular.element(e.children()[0]).css(c,f.$callbacks.calsIndent(d))}}}]).factory("$TreeDnDConvert",function(){return{line2tree:function(d,j,h){if(!d||d.length==0||!j||!h){return[]}var m=[],a=[],k=d[0],b=k[j],l={},e,g,f=d.length,c=0;while(c<f){k=d[c++];b=k[j];l[b]=k;e=k[h];if(e){g=l[e];if(g.__children__){g.__children__.push(k)}else{g.__children__=[k]}}else{a.push(b)}}f=a.length;for(c=0;c<f;c++){m.push(l[a[c]])}return m},tree2tree:function(c,a){var b=function(g){var i=[];var f,d=g.length,h,e;for(f=0;f<d;f++){h=angular.copy(g[f]);if(angular.isArray(h[a])&&h[a].length>0){e=b(h[a]);delete (h[a]);h.__children__=e}i.push(h)}return i};return b(c)}}}).constant("tgConfig",{treeClass:"tree-dnd",emptyTreeClass:"tree-dnd-empty",hiddenClass:"tree-dnd-hidden",nodeClass:"tree-dnd-node",nodesClass:"tree-dnd-nodes",handleClass:"tree-dnd-handle",placeHolderClass:"tree-dnd-placeholder",dragClass:"tree-dnd-drag",statusClass:"tree-dnd-status",levelThreshold:30})}).call(window);